# 睡眠小程序数据库设计文档

**项目名称**: 失眠患者用药跟踪与量表填写系统
**文档版本**: V1.0
**编写日期**: 2025年1月
**数据库类型**: PostgreSQL 14+

---

## 目录

1. [数据库选型](#1-数据库选型)
2. [数据库架构](#2-数据库架构)
3. [数据表设计](#3-数据表设计)
4. [索引设计](#4-索引设计)
5. [约束设计](#5-约束设计)
6. [触发器设计](#6-触发器设计)
7. [数据初始化](#7-数据初始化)
8. [ER图说明](#8-er图说明)
9. [数据库优化策略](#9-数据库优化策略)
10. [附录](#10-附录)

---

## 1. 数据库选型

### 1.1 选型决策: PostgreSQL 14+

**选择理由**:

1. **数据完整性要求高**
   - 医疗数据对ACID特性要求极高
   - PostgreSQL提供强大的事务支持和数据一致性保证
   - 支持复杂的外键约束和级联操作

2. **JSONB字段支持**
   - 量表题目和选项配置需要灵活存储
   - JSONB类型支持高效的JSON数据存储和查询
   - 支持GIN索引加速JSON查询

3. **复杂查询能力**
   - 系统需要多维度统计分析(量表得分、AE统计、用药分析等)
   - PostgreSQL的窗口函数、CTE等特性支持复杂业务查询
   - 全文检索能力

4. **触发器和存储过程**
   - 时间窗口自动计算需要数据库触发器
   - 复杂业务逻辑可通过存储过程实现

5. **开源免费**
   - 无许可费用
   - 社区活跃,文档完善
   - 丰富的扩展插件生态

6. **性能优越**
   - 支持并发控制(MVCC)
   - 查询优化器成熟
   - 适合中小规模数据量(预计10万级患者数据)

### 1.2 数据库配置

```ini
# PostgreSQL配置建议

# 连接设置
max_connections = 200
superuser_reserved_connections = 3

# 内存设置(假设服务器8GB内存)
shared_buffers = 2GB
effective_cache_size = 6GB
maintenance_work_mem = 512MB
work_mem = 10MB

# 预写日志(WAL)
wal_level = replica
max_wal_size = 2GB
min_wal_size = 1GB

# 查询优化
random_page_cost = 1.1
effective_io_concurrency = 200

# 日志设置
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_min_duration_statement = 1000ms
```

### 1.3 字符集和时区

```sql
-- 数据库创建
CREATE DATABASE sleep_tracking
  WITH OWNER = postgres
  ENCODING = 'UTF8'
  LC_COLLATE = 'zh_CN.UTF-8'
  LC_CTYPE = 'zh_CN.UTF-8'
  TABLESPACE = pg_default
  CONNECTION LIMIT = -1;

-- 设置时区
SET timezone = 'Asia/Shanghai';
```

---

## 2. 数据库架构

### 2.1 数据库逻辑架构

```
sleep_tracking (数据库)
├── public (schema)
│   ├── 用户管理表组
│   │   ├── users (用户基础表)
│   │   ├── hospitals (医院表)
│   │   ├── doctors (医生表)
│   │   └── patients (患者表)
│   ├── 业务流程表组
│   │   ├── stage_records (阶段记录表)
│   │   ├── audit_logs (审核记录表)
│   │   └── push_messages (推送消息表)
│   ├── 量表管理表组
│   │   ├── scale_configs (量表配置表)
│   │   └── scale_records (量表记录表)
│   ├── 用药管理表组
│   │   ├── medication_records (用药记录表)
│   │   └── concomitant_medications (合并用药表)
│   ├── AE管理表组
│   │   ├── adverse_events (不良事件表)
│   │   └── ae_attachments (AE附件表)
│   ├── 文件管理表组
│   │   └── medical_files (病例文件表)
│   └── 系统管理表组
│       ├── system_configs (系统配置表)
│       └── operation_logs (操作日志表)
```

### 2.2 表关系概览

- **users** ← **doctors** (一对一)
- **users** ← **patients** (一对一)
- **hospitals** ← **doctors** (一对多)
- **hospitals** ← **patients** (一对多)
- **doctors** ← **patients** (一对多)
- **patients** ← **stage_records** (一对多)
- **stage_records** ← **scale_records** (一对多)
- **stage_records** ← **medication_records** (一对多)
- **stage_records** ← **concomitant_medications** (一对多)
- **stage_records** ← **adverse_events** (一对多)
- **stage_records** ← **medical_files** (一对多)
- **adverse_events** ← **ae_attachments** (一对多)

---

## 3. 数据表设计

### 3.1 用户管理表组

#### 3.1.1 users (用户基础表)

**表说明**: 存储所有用户的基本信息,包括患者、医生、管理员

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 用户ID(自增) |
| openid | VARCHAR(128) | UNIQUE, NOT NULL | - | 微信OpenID |
| unionid | VARCHAR(128) | UNIQUE | - | 微信UnionID(可选) |
| role | VARCHAR(20) | NOT NULL, CHECK | - | 角色:admin/doctor/patient |
| name | VARCHAR(50) | NOT NULL | - | 姓名 |
| gender | VARCHAR(10) | CHECK | - | 性别:male/female |
| birth_date | DATE | - | - | 出生日期 |
| phone | VARCHAR(20) | - | - | 手机号(加密存储) |
| avatar_url | VARCHAR(255) | - | - | 头像URL |
| status | VARCHAR(20) | NOT NULL, CHECK | 'active' | 状态:active/inactive/deleted |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**CHECK约束**:
```sql
ALTER TABLE users ADD CONSTRAINT check_role
  CHECK (role IN ('admin', 'doctor', 'patient'));

ALTER TABLE users ADD CONSTRAINT check_gender
  CHECK (gender IN ('male', 'female'));

ALTER TABLE users ADD CONSTRAINT check_status
  CHECK (status IN ('active', 'inactive', 'deleted'));
```

**注释**:
```sql
COMMENT ON TABLE users IS '用户基础表,存储所有用户(患者、医生、管理员)的基本信息';
COMMENT ON COLUMN users.openid IS '微信OpenID,用于微信登录';
COMMENT ON COLUMN users.unionid IS '微信UnionID,同一开放平台下的唯一标识';
COMMENT ON COLUMN users.phone IS '手机号,使用AES加密存储';
```

#### 3.1.2 hospitals (医院表)

**表说明**: 存储医院信息,支持多医院使用

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | SERIAL | PRIMARY KEY | - | 医院ID(自增) |
| name | VARCHAR(100) | NOT NULL, UNIQUE | - | 医院名称 |
| province | VARCHAR(50) | - | - | 省份 |
| city | VARCHAR(50) | - | - | 城市 |
| address | VARCHAR(255) | - | - | 详细地址 |
| contact_phone | VARCHAR(20) | - | - | 联系电话 |
| status | VARCHAR(20) | NOT NULL, CHECK | 'active' | 状态:active/inactive |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**CHECK约束**:
```sql
ALTER TABLE hospitals ADD CONSTRAINT check_hospital_status
  CHECK (status IN ('active', 'inactive'));
```

**注释**:
```sql
COMMENT ON TABLE hospitals IS '医院表,支持多医院数据隔离';
COMMENT ON COLUMN hospitals.name IS '医院名称,全局唯一';
```

#### 3.1.3 doctors (医生表)

**表说明**: 存储医生专属信息及审核状态

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 医生ID(自增) |
| user_id | BIGINT | UNIQUE, NOT NULL, FK → users(id) | - | 关联用户ID |
| hospital_id | INT | NOT NULL, FK → hospitals(id) | - | 关联医院ID |
| employee_no | VARCHAR(50) | - | - | 工号 |
| department | VARCHAR(100) | - | - | 科室 |
| title | VARCHAR(50) | - | - | 职称 |
| qualification_cert_url | VARCHAR(255) | - | - | 资质证明文件URL |
| audit_status | VARCHAR(20) | NOT NULL, CHECK | 'pending' | 审核状态:pending/approved/rejected |
| audit_remark | TEXT | - | - | 审核备注 |
| audited_at | TIMESTAMP | - | - | 审核时间 |
| audited_by | BIGINT | FK → users(id) | - | 审核人ID |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**CHECK约束**:
```sql
ALTER TABLE doctors ADD CONSTRAINT check_audit_status
  CHECK (audit_status IN ('pending', 'approved', 'rejected'));
```

**注释**:
```sql
COMMENT ON TABLE doctors IS '医生表,存储医生专属信息及审核状态';
COMMENT ON COLUMN doctors.audit_status IS '审核状态:pending-待审核,approved-已通过,rejected-已驳回';
```

#### 3.1.4 patients (患者表)

**表说明**: 存储患者信息及四阶段时间窗口

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 患者ID(自增) |
| user_id | BIGINT | UNIQUE, NOT NULL, FK → users(id) | - | 关联用户ID |
| patient_no | VARCHAR(50) | UNIQUE, NOT NULL | - | 患者编号(自动生成) |
| doctor_id | BIGINT | NOT NULL, FK → doctors(id) | - | 主治医生ID |
| hospital_id | INT | NOT NULL, FK → hospitals(id) | - | 就诊医院ID |
| current_stage | VARCHAR(10) | NOT NULL, CHECK | 'V1' | 当前阶段:V1/V2/V3/V4/completed |
| enrollment_date | DATE | NOT NULL | CURRENT_DATE | 入组日期 |
| v1_completed_at | TIMESTAMP | - | - | V1完成时间 |
| v2_window_start | DATE | - | - | V2时间窗口开始日期 |
| v2_window_end | DATE | - | - | V2时间窗口结束日期 |
| v2_completed_at | TIMESTAMP | - | - | V2完成时间 |
| v3_window_start | DATE | - | - | V3时间窗口开始日期 |
| v3_window_end | DATE | - | - | V3时间窗口结束日期 |
| v3_completed_at | TIMESTAMP | - | - | V3完成时间 |
| v4_window_start | DATE | - | - | V4时间窗口开始日期 |
| v4_window_end | DATE | - | - | V4时间窗口结束日期 |
| v4_completed_at | TIMESTAMP | - | - | V4完成时间 |
| status | VARCHAR(20) | NOT NULL, CHECK | 'active' | 状态:active/completed/withdrawn |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**CHECK约束**:
```sql
ALTER TABLE patients ADD CONSTRAINT check_current_stage
  CHECK (current_stage IN ('V1', 'V2', 'V3', 'V4', 'completed'));

ALTER TABLE patients ADD CONSTRAINT check_patient_status
  CHECK (status IN ('active', 'completed', 'withdrawn'));
```

**注释**:
```sql
COMMENT ON TABLE patients IS '患者表,存储患者信息及四阶段时间窗口';
COMMENT ON COLUMN patients.patient_no IS '患者编号,格式:P+年月日时分秒+随机4位数,例:P20250115142530A1B2';
COMMENT ON COLUMN patients.v2_window_start IS 'V2时间窗口开始日期,由触发器自动计算:V1审核通过日期+6天';
COMMENT ON COLUMN patients.v2_window_end IS 'V2时间窗口结束日期,由触发器自动计算:V1审核通过日期+8天';
```

---

### 3.2 业务流程表组

#### 3.2.1 stage_records (阶段记录表)

**表说明**: 记录患者每个阶段的提交和审核状态

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 记录ID(自增) |
| patient_id | BIGINT | NOT NULL, FK → patients(id) | - | 患者ID |
| stage | VARCHAR(10) | NOT NULL, CHECK | - | 阶段:V1/V2/V3/V4 |
| status | VARCHAR(20) | NOT NULL, CHECK | 'draft' | 状态:draft/submitted/approved/rejected |
| submitted_at | TIMESTAMP | - | - | 提交时间 |
| audited_at | TIMESTAMP | - | - | 审核时间 |
| audited_by | BIGINT | FK → doctors(id) | - | 审核医生ID |
| audit_result | VARCHAR(20) | CHECK | - | 审核结果:approved/rejected |
| audit_remark | TEXT | - | - | 审核意见 |
| reject_reason | TEXT | - | - | 驳回原因 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**CHECK约束**:
```sql
ALTER TABLE stage_records ADD CONSTRAINT check_stage
  CHECK (stage IN ('V1', 'V2', 'V3', 'V4'));

ALTER TABLE stage_records ADD CONSTRAINT check_record_status
  CHECK (status IN ('draft', 'submitted', 'approved', 'rejected'));

ALTER TABLE stage_records ADD CONSTRAINT check_audit_result
  CHECK (audit_result IN ('approved', 'rejected'));
```

**UNIQUE约束**:
```sql
ALTER TABLE stage_records ADD CONSTRAINT unique_patient_stage
  UNIQUE (patient_id, stage);
```

**注释**:
```sql
COMMENT ON TABLE stage_records IS '阶段记录表,记录患者每个阶段的提交和审核状态';
COMMENT ON COLUMN stage_records.status IS 'draft-草稿,submitted-已提交待审核,approved-审核通过,rejected-审核驳回';
```

#### 3.2.2 audit_logs (审核记录表)

**表说明**: 记录所有审核操作的历史日志

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 审核ID(自增) |
| stage_record_id | BIGINT | NOT NULL, FK → stage_records(id) | - | 阶段记录ID |
| patient_id | BIGINT | NOT NULL, FK → patients(id) | - | 患者ID |
| auditor_id | BIGINT | NOT NULL, FK → doctors(id) | - | 审核人ID |
| audit_result | VARCHAR(20) | NOT NULL, CHECK | - | 审核结果:approved/rejected |
| audit_remark | TEXT | - | - | 审核意见 |
| reject_reason | TEXT | - | - | 驳回原因 |
| audited_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 审核时间 |

**CHECK约束**:
```sql
ALTER TABLE audit_logs ADD CONSTRAINT check_audit_log_result
  CHECK (audit_result IN ('approved', 'rejected'));
```

**注释**:
```sql
COMMENT ON TABLE audit_logs IS '审核记录表,记录所有审核操作的历史日志,用于追溯和统计';
```

#### 3.2.3 push_messages (推送消息表)

**表说明**: 记录所有推送消息及状态

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 消息ID(自增) |
| receiver_id | BIGINT | NOT NULL, FK → users(id) | - | 接收用户ID |
| message_type | VARCHAR(50) | NOT NULL | - | 消息类型 |
| title | VARCHAR(200) | NOT NULL | - | 消息标题 |
| content | TEXT | NOT NULL | - | 消息内容 |
| related_id | BIGINT | - | - | 关联业务ID |
| related_type | VARCHAR(50) | - | - | 关联业务类型:stage/ae/audit |
| push_status | VARCHAR(20) | NOT NULL, CHECK | 'pending' | 推送状态:pending/sent/failed |
| read_status | BOOLEAN | NOT NULL | false | 是否已读 |
| read_at | TIMESTAMP | - | - | 阅读时间 |
| pushed_at | TIMESTAMP | - | - | 推送时间 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**CHECK约束**:
```sql
ALTER TABLE push_messages ADD CONSTRAINT check_push_status
  CHECK (push_status IN ('pending', 'sent', 'failed'));
```

**消息类型说明**:
```
患者端接收:
- audit_approved: 审核通过通知
- audit_rejected: 审核驳回通知
- stage_open: 阶段开放提醒
- stage_overdue: 阶段超时催办

医生端接收:
- patient_bound: 新患者绑定通知
- patient_submitted: 患者提交审核通知
- ae_alert: 严重AE提醒
- patient_overdue: 患者超时未完成提醒
```

**注释**:
```sql
COMMENT ON TABLE push_messages IS '推送消息表,记录所有微信推送消息和站内消息';
COMMENT ON COLUMN push_messages.message_type IS '消息类型:audit_approved/audit_rejected/stage_open/stage_overdue/ae_alert等';
```

---

### 3.3 量表管理表组

#### 3.3.1 scale_configs (量表配置表)

**表说明**: 存储量表的题目、选项、计分规则等配置

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | SERIAL | PRIMARY KEY | - | 配置ID(自增) |
| scale_code | VARCHAR(20) | UNIQUE, NOT NULL | - | 量表代码:AIS/ESS/GAD7/PHQ9/HAMA/HAMD |
| scale_name | VARCHAR(100) | NOT NULL | - | 量表名称 |
| scale_type | VARCHAR(20) | NOT NULL, CHECK | - | 类型:self/doctor(自评/医生代填) |
| total_items | INT | NOT NULL | - | 题目总数 |
| config_json | JSONB | NOT NULL | - | 量表配置(题目、选项、计分规则) |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**CHECK约束**:
```sql
ALTER TABLE scale_configs ADD CONSTRAINT check_scale_type
  CHECK (scale_type IN ('self', 'doctor'));
```

**config_json结构示例**:
```json
{
  "items": [
    {
      "id": 1,
      "question": "入睡延迟(关灯后到入睡的时间)",
      "options": [
        {"value": 0, "label": "没有问题(小于10分钟)"},
        {"value": 1, "label": "轻微(10-30分钟)"},
        {"value": 2, "label": "明显(30-60分钟)"},
        {"value": 3, "label": "显著或基本没睡(大于1小时)"}
      ]
    }
  ],
  "scoring": {
    "type": "sum",
    "max_score": 24,
    "description": "各题得分相加"
  }
}
```

**注释**:
```sql
COMMENT ON TABLE scale_configs IS '量表配置表,存储6个量表的题目、选项、计分规则';
COMMENT ON COLUMN scale_configs.config_json IS 'JSONB格式存储量表配置,支持灵活扩展';
```

#### 3.3.2 scale_records (量表记录表)

**表说明**: 记录患者每次量表填写的答案和得分

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 记录ID(自增) |
| patient_id | BIGINT | NOT NULL, FK → patients(id) | - | 患者ID |
| stage_record_id | BIGINT | NOT NULL, FK → stage_records(id) | - | 阶段记录ID |
| scale_code | VARCHAR(20) | NOT NULL | - | 量表代码 |
| answers_json | JSONB | NOT NULL | - | 答题详情 |
| total_score | DECIMAL(10,2) | - | - | 总分 |
| filled_by | VARCHAR(20) | NOT NULL, CHECK | - | 填写人类型:patient/doctor |
| filled_by_user_id | BIGINT | NOT NULL, FK → users(id) | - | 填写人用户ID |
| completed_at | TIMESTAMP | - | - | 完成时间 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**CHECK约束**:
```sql
ALTER TABLE scale_records ADD CONSTRAINT check_filled_by
  CHECK (filled_by IN ('patient', 'doctor'));
```

**answers_json结构示例**:
```json
{
  "answers": [
    {"item_id": 1, "value": 2},
    {"item_id": 2, "value": 1},
    {"item_id": 3, "value": 3},
    {"item_id": 4, "value": 2},
    {"item_id": 5, "value": 1},
    {"item_id": 6, "value": 2},
    {"item_id": 7, "value": 1},
    {"item_id": 8, "value": 0}
  ]
}
```

**注释**:
```sql
COMMENT ON TABLE scale_records IS '量表记录表,记录患者每次量表填写的答案和得分';
COMMENT ON COLUMN scale_records.answers_json IS 'JSONB格式存储答题详情,每题的答案值';
COMMENT ON COLUMN scale_records.total_score IS '总分,由系统根据计分规则自动计算';
```

---

### 3.4 用药管理表组

#### 3.4.1 medication_records (用药记录表)

**表说明**: 记录患者主要研究用药(莱博雷生)情况

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 记录ID(自增) |
| patient_id | BIGINT | NOT NULL, FK → patients(id) | - | 患者ID |
| stage_record_id | BIGINT | NOT NULL, FK → stage_records(id) | - | 阶段记录ID |
| drug_name | VARCHAR(100) | NOT NULL | '莱博雷生' | 药品名称(固定) |
| dosage | VARCHAR(20) | NOT NULL, CHECK | - | 剂量:5mg/10mg |
| dosage_form | VARCHAR(50) | - | '片剂' | 剂型 |
| frequency | VARCHAR(50) | NOT NULL | - | 用药频率 |
| administration_route | VARCHAR(50) | - | '口服' | 给药途径 |
| start_date | DATE | NOT NULL | - | 开始时间 |
| end_date | DATE | - | - | 结束时间 |
| duration_days | INT | - | - | 用药天数(自动计算) |
| compliance | VARCHAR(20) | CHECK | - | 依从性:good/fair/poor |
| remark | TEXT | - | - | 备注 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**CHECK约束**:
```sql
ALTER TABLE medication_records ADD CONSTRAINT check_dosage
  CHECK (dosage IN ('5mg', '10mg'));

ALTER TABLE medication_records ADD CONSTRAINT check_compliance
  CHECK (compliance IN ('good', 'fair', 'poor'));
```

**注释**:
```sql
COMMENT ON TABLE medication_records IS '用药记录表,记录患者主要研究用药(莱博雷生)情况';
COMMENT ON COLUMN medication_records.drug_name IS '药品名称,固定为"莱博雷生"';
COMMENT ON COLUMN medication_records.dosage IS '剂量,只能选择5mg或10mg';
COMMENT ON COLUMN medication_records.compliance IS '依从性:good-良好,fair-一般,poor-差';
```

#### 3.4.2 concomitant_medications (合并用药表)

**表说明**: 记录患者合并使用的其他药物

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 记录ID(自增) |
| patient_id | BIGINT | NOT NULL, FK → patients(id) | - | 患者ID |
| stage_record_id | BIGINT | NOT NULL, FK → stage_records(id) | - | 阶段记录ID |
| drug_name | VARCHAR(100) | NOT NULL | - | 药品名称 |
| drug_category | VARCHAR(50) | - | - | 药品分类 |
| dosage | VARCHAR(50) | NOT NULL | - | 剂量 |
| frequency | VARCHAR(50) | - | - | 用药频率 |
| indication | VARCHAR(255) | NOT NULL | - | 用药原因/适应症 |
| start_date | DATE | NOT NULL | - | 开始时间 |
| end_date | DATE | - | - | 结束时间(NULL表示持续中) |
| is_ongoing | BOOLEAN | NOT NULL | false | 是否持续中 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**注释**:
```sql
COMMENT ON TABLE concomitant_medications IS '合并用药表,记录患者合并使用的其他药物';
COMMENT ON COLUMN concomitant_medications.is_ongoing IS '是否持续中,true表示仍在用药,end_date为NULL';
```

---

### 3.5 AE管理表组

#### 3.5.1 adverse_events (不良事件表)

**表说明**: 记录患者不良事件

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | AE ID(自增) |
| patient_id | BIGINT | NOT NULL, FK → patients(id) | - | 患者ID |
| stage_record_id | BIGINT | NOT NULL, FK → stage_records(id) | - | 阶段记录ID |
| event_name | VARCHAR(200) | NOT NULL | - | 事件名称 |
| event_description | TEXT | NOT NULL | - | 事件描述 |
| severity | VARCHAR(20) | NOT NULL, CHECK | - | 严重程度:mild/moderate/severe |
| onset_date | DATE | NOT NULL | - | 发生日期 |
| onset_time | TIME | - | - | 发生时间 |
| duration | VARCHAR(100) | - | - | 持续时间 |
| relationship | VARCHAR(50) | CHECK | - | 与研究药物关系 |
| requires_intervention | BOOLEAN | NOT NULL | false | 是否需要医疗干预 |
| intervention_details | TEXT | - | - | 处理措施 |
| outcome | VARCHAR(50) | CHECK | - | 结局 |
| is_serious | BOOLEAN | NOT NULL | false | 是否严重AE |
| reported_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 报告时间 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**CHECK约束**:
```sql
ALTER TABLE adverse_events ADD CONSTRAINT check_severity
  CHECK (severity IN ('mild', 'moderate', 'severe'));

ALTER TABLE adverse_events ADD CONSTRAINT check_relationship
  CHECK (relationship IN ('unrelated', 'unlikely', 'possible', 'probable', 'definite'));

ALTER TABLE adverse_events ADD CONSTRAINT check_outcome
  CHECK (outcome IN ('recovered', 'recovering', 'not_recovered', 'sequelae', 'death'));
```

**注释**:
```sql
COMMENT ON TABLE adverse_events IS '不良事件表,记录患者不良事件';
COMMENT ON COLUMN adverse_events.severity IS '严重程度:mild-轻度,moderate-中度,severe-重度';
COMMENT ON COLUMN adverse_events.relationship IS '与研究药物关系:unrelated-无关,unlikely-不太可能,possible-可能,probable-很可能,definite-肯定';
COMMENT ON COLUMN adverse_events.outcome IS '结局:recovered-已恢复,recovering-恢复中,not_recovered-未恢复,sequelae-有后遗症,death-死亡';
COMMENT ON COLUMN adverse_events.is_serious IS '是否严重AE,由触发器自动判断:severity=severe或outcome=death时为true';
```

#### 3.5.2 ae_attachments (AE附件表)

**表说明**: 存储AE相关的附件文件

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 附件ID(自增) |
| ae_id | BIGINT | NOT NULL, FK → adverse_events(id) | - | 不良事件ID |
| file_name | VARCHAR(255) | NOT NULL | - | 文件名 |
| file_url | VARCHAR(500) | NOT NULL | - | 文件URL(OSS) |
| file_size | BIGINT | - | - | 文件大小(字节) |
| file_type | VARCHAR(50) | - | - | 文件类型 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**注释**:
```sql
COMMENT ON TABLE ae_attachments IS 'AE附件表,存储AE相关的检查报告等附件文件';
```

---

### 3.6 文件管理表组

#### 3.6.1 medical_files (病例文件表)

**表说明**: 存储患者上传的病例文件

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 文件ID(自增) |
| patient_id | BIGINT | NOT NULL, FK → patients(id) | - | 患者ID |
| stage_record_id | BIGINT | NOT NULL, FK → stage_records(id) | - | 阶段记录ID |
| file_category | VARCHAR(50) | NOT NULL, CHECK | - | 文件分类 |
| file_name | VARCHAR(255) | NOT NULL | - | 文件名 |
| file_url | VARCHAR(500) | NOT NULL | - | 文件URL(OSS) |
| file_size | BIGINT | NOT NULL | - | 文件大小(字节) |
| file_type | VARCHAR(50) | NOT NULL | - | 文件类型:image/pdf/doc |
| mime_type | VARCHAR(100) | - | - | MIME类型 |
| uploaded_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 上传时间 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**CHECK约束**:
```sql
ALTER TABLE medical_files ADD CONSTRAINT check_file_category
  CHECK (file_category IN ('检查报告', '影像资料', '病历记录', '其他'));

ALTER TABLE medical_files ADD CONSTRAINT check_file_type
  CHECK (file_type IN ('image', 'pdf', 'doc'));
```

**注释**:
```sql
COMMENT ON TABLE medical_files IS '病例文件表,存储患者上传的病例文件';
COMMENT ON COLUMN medical_files.file_url IS '文件URL,存储在阿里云OSS';
```

---

### 3.7 系统管理表组

#### 3.7.1 system_configs (系统配置表)

**表说明**: 存储系统参数配置

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | SERIAL | PRIMARY KEY | - | 配置ID(自增) |
| config_key | VARCHAR(100) | UNIQUE, NOT NULL | - | 配置键 |
| config_value | TEXT | NOT NULL | - | 配置值 |
| config_type | VARCHAR(20) | - | 'string' | 配置类型:string/number/json |
| description | VARCHAR(255) | - | - | 配置说明 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**注释**:
```sql
COMMENT ON TABLE system_configs IS '系统配置表,存储时间窗口参数等系统配置';
```

#### 3.7.2 operation_logs (操作日志表)

**表说明**: 记录用户操作日志,用于审计

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | - | 日志ID(自增) |
| user_id | BIGINT | FK → users(id) | - | 操作用户ID |
| operation_type | VARCHAR(50) | NOT NULL | - | 操作类型 |
| operation_module | VARCHAR(50) | NOT NULL | - | 操作模块 |
| operation_desc | TEXT | - | - | 操作描述 |
| ip_address | VARCHAR(50) | - | - | IP地址 |
| user_agent | VARCHAR(255) | - | - | 用户代理 |
| request_params | JSONB | - | - | 请求参数 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 操作时间 |

**注释**:
```sql
COMMENT ON TABLE operation_logs IS '操作日志表,记录用户操作日志用于审计';
COMMENT ON COLUMN operation_logs.operation_type IS '操作类型:login/logout/create/update/delete/export等';
```

---

## 4. 索引设计

### 4.1 唯一索引

```sql
-- users表
CREATE UNIQUE INDEX uk_users_openid ON users(openid);
CREATE UNIQUE INDEX uk_users_unionid ON users(unionid) WHERE unionid IS NOT NULL;

-- hospitals表
CREATE UNIQUE INDEX uk_hospitals_name ON hospitals(name);

-- doctors表
CREATE UNIQUE INDEX uk_doctors_user_id ON doctors(user_id);

-- patients表
CREATE UNIQUE INDEX uk_patients_user_id ON patients(user_id);
CREATE UNIQUE INDEX uk_patients_patient_no ON patients(patient_no);

-- stage_records表
CREATE UNIQUE INDEX uk_stage_patient_stage ON stage_records(patient_id, stage);

-- scale_configs表
CREATE UNIQUE INDEX uk_scale_code ON scale_configs(scale_code);

-- system_configs表
CREATE UNIQUE INDEX uk_config_key ON system_configs(config_key);
```

### 4.2 普通索引

```sql
-- users表
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_status ON users(status);

-- doctors表
CREATE INDEX idx_doctors_hospital_id ON doctors(hospital_id);
CREATE INDEX idx_doctors_audit_status ON doctors(audit_status);

-- patients表
CREATE INDEX idx_patients_doctor_id ON patients(doctor_id);
CREATE INDEX idx_patients_hospital_id ON patients(hospital_id);
CREATE INDEX idx_patients_current_stage ON patients(current_stage);
CREATE INDEX idx_patients_enrollment_date ON patients(enrollment_date);

-- stage_records表
CREATE INDEX idx_stage_patient_id ON stage_records(patient_id);
CREATE INDEX idx_stage_status ON stage_records(status);
CREATE INDEX idx_stage_submitted_at ON stage_records(submitted_at);

-- scale_records表
CREATE INDEX idx_scale_patient_id ON scale_records(patient_id);
CREATE INDEX idx_scale_stage_record_id ON scale_records(stage_record_id);
CREATE INDEX idx_scale_code ON scale_records(scale_code);
CREATE INDEX idx_scale_completed_at ON scale_records(completed_at);

-- medication_records表
CREATE INDEX idx_medication_patient_id ON medication_records(patient_id);
CREATE INDEX idx_medication_stage_record_id ON medication_records(stage_record_id);

-- concomitant_medications表
CREATE INDEX idx_conmed_patient_id ON concomitant_medications(patient_id);
CREATE INDEX idx_conmed_stage_record_id ON concomitant_medications(stage_record_id);

-- adverse_events表
CREATE INDEX idx_ae_patient_id ON adverse_events(patient_id);
CREATE INDEX idx_ae_stage_record_id ON adverse_events(stage_record_id);
CREATE INDEX idx_ae_severity ON adverse_events(severity);
CREATE INDEX idx_ae_is_serious ON adverse_events(is_serious);
CREATE INDEX idx_ae_reported_at ON adverse_events(reported_at);

-- ae_attachments表
CREATE INDEX idx_ae_attach_ae_id ON ae_attachments(ae_id);

-- medical_files表
CREATE INDEX idx_file_patient_id ON medical_files(patient_id);
CREATE INDEX idx_file_stage_record_id ON medical_files(stage_record_id);
CREATE INDEX idx_file_uploaded_at ON medical_files(uploaded_at);

-- audit_logs表
CREATE INDEX idx_audit_stage_record_id ON audit_logs(stage_record_id);
CREATE INDEX idx_audit_patient_id ON audit_logs(patient_id);
CREATE INDEX idx_audit_auditor_id ON audit_logs(auditor_id);
CREATE INDEX idx_audit_audited_at ON audit_logs(audited_at);

-- push_messages表
CREATE INDEX idx_message_receiver_id ON push_messages(receiver_id);
CREATE INDEX idx_message_read_status ON push_messages(receiver_id, read_status);
CREATE INDEX idx_message_created_at ON push_messages(created_at);

-- operation_logs表
CREATE INDEX idx_log_user_id ON operation_logs(user_id);
CREATE INDEX idx_log_created_at ON operation_logs(created_at);
CREATE INDEX idx_log_operation_type ON operation_logs(operation_type);
```

### 4.3 GIN索引(JSONB字段)

```sql
-- scale_configs表
CREATE INDEX idx_scale_config_json ON scale_configs USING GIN (config_json);

-- scale_records表
CREATE INDEX idx_scale_answers_json ON scale_records USING GIN (answers_json);

-- operation_logs表
CREATE INDEX idx_log_request_params ON operation_logs USING GIN (request_params);
```

### 4.4 复合索引

```sql
-- patients表:常用查询组合
CREATE INDEX idx_patients_hospital_stage ON patients(hospital_id, current_stage);
CREATE INDEX idx_patients_doctor_stage ON patients(doctor_id, current_stage);

-- stage_records表:常用查询组合
CREATE INDEX idx_stage_patient_status ON stage_records(patient_id, status);

-- scale_records表:常用查询组合
CREATE INDEX idx_scale_patient_code ON scale_records(patient_id, scale_code);

-- push_messages表:常用查询组合
CREATE INDEX idx_message_receiver_read ON push_messages(receiver_id, read_status, created_at DESC);
```

---

## 5. 约束设计

### 5.1 外键约束

```sql
-- doctors表外键
ALTER TABLE doctors
  ADD CONSTRAINT fk_doctors_user
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

ALTER TABLE doctors
  ADD CONSTRAINT fk_doctors_hospital
  FOREIGN KEY (hospital_id) REFERENCES hospitals(id) ON DELETE RESTRICT;

ALTER TABLE doctors
  ADD CONSTRAINT fk_doctors_auditor
  FOREIGN KEY (audited_by) REFERENCES users(id) ON DELETE SET NULL;

-- patients表外键
ALTER TABLE patients
  ADD CONSTRAINT fk_patients_user
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

ALTER TABLE patients
  ADD CONSTRAINT fk_patients_doctor
  FOREIGN KEY (doctor_id) REFERENCES doctors(id) ON DELETE RESTRICT;

ALTER TABLE patients
  ADD CONSTRAINT fk_patients_hospital
  FOREIGN KEY (hospital_id) REFERENCES hospitals(id) ON DELETE RESTRICT;

-- stage_records表外键
ALTER TABLE stage_records
  ADD CONSTRAINT fk_stage_patient
  FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE;

ALTER TABLE stage_records
  ADD CONSTRAINT fk_stage_auditor
  FOREIGN KEY (audited_by) REFERENCES doctors(id) ON DELETE SET NULL;

-- scale_records表外键
ALTER TABLE scale_records
  ADD CONSTRAINT fk_scale_patient
  FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE;

ALTER TABLE scale_records
  ADD CONSTRAINT fk_scale_stage_record
  FOREIGN KEY (stage_record_id) REFERENCES stage_records(id) ON DELETE CASCADE;

ALTER TABLE scale_records
  ADD CONSTRAINT fk_scale_filled_by_user
  FOREIGN KEY (filled_by_user_id) REFERENCES users(id) ON DELETE SET NULL;

-- medication_records表外键
ALTER TABLE medication_records
  ADD CONSTRAINT fk_medication_patient
  FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE;

ALTER TABLE medication_records
  ADD CONSTRAINT fk_medication_stage_record
  FOREIGN KEY (stage_record_id) REFERENCES stage_records(id) ON DELETE CASCADE;

-- concomitant_medications表外键
ALTER TABLE concomitant_medications
  ADD CONSTRAINT fk_conmed_patient
  FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE;

ALTER TABLE concomitant_medications
  ADD CONSTRAINT fk_conmed_stage_record
  FOREIGN KEY (stage_record_id) REFERENCES stage_records(id) ON DELETE CASCADE;

-- adverse_events表外键
ALTER TABLE adverse_events
  ADD CONSTRAINT fk_ae_patient
  FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE;

ALTER TABLE adverse_events
  ADD CONSTRAINT fk_ae_stage_record
  FOREIGN KEY (stage_record_id) REFERENCES stage_records(id) ON DELETE CASCADE;

-- ae_attachments表外键
ALTER TABLE ae_attachments
  ADD CONSTRAINT fk_ae_attach_ae
  FOREIGN KEY (ae_id) REFERENCES adverse_events(id) ON DELETE CASCADE;

-- medical_files表外键
ALTER TABLE medical_files
  ADD CONSTRAINT fk_file_patient
  FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE;

ALTER TABLE medical_files
  ADD CONSTRAINT fk_file_stage_record
  FOREIGN KEY (stage_record_id) REFERENCES stage_records(id) ON DELETE CASCADE;

-- audit_logs表外键
ALTER TABLE audit_logs
  ADD CONSTRAINT fk_audit_stage_record
  FOREIGN KEY (stage_record_id) REFERENCES stage_records(id) ON DELETE CASCADE;

ALTER TABLE audit_logs
  ADD CONSTRAINT fk_audit_patient
  FOREIGN KEY (patient_id) REFERENCES patients(id) ON DELETE CASCADE;

ALTER TABLE audit_logs
  ADD CONSTRAINT fk_audit_auditor
  FOREIGN KEY (auditor_id) REFERENCES doctors(id) ON DELETE SET NULL;

-- push_messages表外键
ALTER TABLE push_messages
  ADD CONSTRAINT fk_message_receiver
  FOREIGN KEY (receiver_id) REFERENCES users(id) ON DELETE CASCADE;

-- operation_logs表外键
ALTER TABLE operation_logs
  ADD CONSTRAINT fk_log_user
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL;
```

**外键级联策略说明**:
- `ON DELETE CASCADE`: 主表删除时级联删除子表记录
- `ON DELETE RESTRICT`: 主表删除时如果有子表引用则禁止删除
- `ON DELETE SET NULL`: 主表删除时子表外键设为NULL

---

## 6. 触发器设计

### 6.1 自动更新updated_at触发器

```sql
-- 创建触发器函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 为各表创建触发器
CREATE TRIGGER trg_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_hospitals_updated_at
  BEFORE UPDATE ON hospitals
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_doctors_updated_at
  BEFORE UPDATE ON doctors
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_patients_updated_at
  BEFORE UPDATE ON patients
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_stage_records_updated_at
  BEFORE UPDATE ON stage_records
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_scale_configs_updated_at
  BEFORE UPDATE ON scale_configs
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_scale_records_updated_at
  BEFORE UPDATE ON scale_records
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_medication_records_updated_at
  BEFORE UPDATE ON medication_records
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_concomitant_medications_updated_at
  BEFORE UPDATE ON concomitant_medications
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_adverse_events_updated_at
  BEFORE UPDATE ON adverse_events
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_system_configs_updated_at
  BEFORE UPDATE ON system_configs
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

### 6.2 时间窗口自动计算触发器

#### 6.2.1 V1审核通过后计算V2时间窗口

```sql
CREATE OR REPLACE FUNCTION calculate_v2_window()
RETURNS TRIGGER AS $$
DECLARE
  v_v1_to_v2_days INT;
  v_v1_to_v2_tolerance INT;
BEGIN
  -- 仅当V1阶段审核通过时执行
  IF NEW.stage = 'V1' AND NEW.audit_result = 'approved' THEN
    -- 从系统配置表读取参数
    SELECT config_value::INT INTO v_v1_to_v2_days
    FROM system_configs WHERE config_key = 'v1_to_v2_days';

    SELECT config_value::INT INTO v_v1_to_v2_tolerance
    FROM system_configs WHERE config_key = 'v1_to_v2_tolerance';

    -- 更新患者表
    UPDATE patients
    SET
      v1_completed_at = NEW.audited_at,
      v2_window_start = NEW.audited_at::date + (v_v1_to_v2_days - v_v1_to_v2_tolerance) * INTERVAL '1 day',
      v2_window_end = NEW.audited_at::date + (v_v1_to_v2_days + v_v1_to_v2_tolerance) * INTERVAL '1 day',
      current_stage = 'V2',
      updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.patient_id;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_calculate_v2_window
  AFTER UPDATE ON stage_records
  FOR EACH ROW
  EXECUTE FUNCTION calculate_v2_window();
```

#### 6.2.2 V2审核通过后计算V3时间窗口

```sql
CREATE OR REPLACE FUNCTION calculate_v3_window()
RETURNS TRIGGER AS $$
DECLARE
  v_v2_to_v3_days INT;
  v_v2_to_v3_tolerance INT;
BEGIN
  IF NEW.stage = 'V2' AND NEW.audit_result = 'approved' THEN
    SELECT config_value::INT INTO v_v2_to_v3_days
    FROM system_configs WHERE config_key = 'v2_to_v3_days';

    SELECT config_value::INT INTO v_v2_to_v3_tolerance
    FROM system_configs WHERE config_key = 'v2_to_v3_tolerance';

    UPDATE patients
    SET
      v2_completed_at = NEW.audited_at,
      v3_window_start = NEW.audited_at::date + (v_v2_to_v3_days - v_v2_to_v3_tolerance) * INTERVAL '1 day',
      v3_window_end = NEW.audited_at::date + (v_v2_to_v3_days + v_v2_to_v3_tolerance) * INTERVAL '1 day',
      current_stage = 'V3',
      updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.patient_id;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_calculate_v3_window
  AFTER UPDATE ON stage_records
  FOR EACH ROW
  EXECUTE FUNCTION calculate_v3_window();
```

#### 6.2.3 V3审核通过后计算V4时间窗口

```sql
CREATE OR REPLACE FUNCTION calculate_v4_window()
RETURNS TRIGGER AS $$
DECLARE
  v_v3_to_v4_days INT;
  v_v3_to_v4_tolerance INT;
BEGIN
  IF NEW.stage = 'V3' AND NEW.audit_result = 'approved' THEN
    SELECT config_value::INT INTO v_v3_to_v4_days
    FROM system_configs WHERE config_key = 'v3_to_v4_days';

    SELECT config_value::INT INTO v_v3_to_v4_tolerance
    FROM system_configs WHERE config_key = 'v3_to_v4_tolerance';

    UPDATE patients
    SET
      v3_completed_at = NEW.audited_at,
      v4_window_start = NEW.audited_at::date + (v_v3_to_v4_days - v_v3_to_v4_tolerance) * INTERVAL '1 day',
      v4_window_end = NEW.audited_at::date + (v_v3_to_v4_days + v_v3_to_v4_tolerance) * INTERVAL '1 day',
      current_stage = 'V4',
      updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.patient_id;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_calculate_v4_window
  AFTER UPDATE ON stage_records
  FOR EACH ROW
  EXECUTE FUNCTION calculate_v4_window();
```

#### 6.2.4 V4审核通过后标记完成

```sql
CREATE OR REPLACE FUNCTION mark_patient_completed()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.stage = 'V4' AND NEW.audit_result = 'approved' THEN
    UPDATE patients
    SET
      v4_completed_at = NEW.audited_at,
      current_stage = 'completed',
      status = 'completed',
      updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.patient_id;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_mark_patient_completed
  AFTER UPDATE ON stage_records
  FOR EACH ROW
  EXECUTE FUNCTION mark_patient_completed();
```

### 6.3 自动标记严重AE触发器

```sql
CREATE OR REPLACE FUNCTION mark_serious_ae()
RETURNS TRIGGER AS $$
BEGIN
  -- 严重程度为severe或结局为death时自动标记为严重AE
  IF NEW.severity = 'severe' OR NEW.outcome = 'death' THEN
    NEW.is_serious := true;
  ELSE
    NEW.is_serious := false;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_mark_serious_ae
  BEFORE INSERT OR UPDATE ON adverse_events
  FOR EACH ROW
  EXECUTE FUNCTION mark_serious_ae();
```

### 6.4 用药天数自动计算触发器

```sql
CREATE OR REPLACE FUNCTION calculate_medication_duration()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.start_date IS NOT NULL AND NEW.end_date IS NOT NULL THEN
    NEW.duration_days := NEW.end_date - NEW.start_date + 1;
  ELSIF NEW.start_date IS NOT NULL THEN
    NEW.duration_days := CURRENT_DATE - NEW.start_date + 1;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_calculate_medication_duration
  BEFORE INSERT OR UPDATE ON medication_records
  FOR EACH ROW
  EXECUTE FUNCTION calculate_medication_duration();
```

### 6.5 患者编号自动生成触发器

```sql
CREATE OR REPLACE FUNCTION generate_patient_no()
RETURNS TRIGGER AS $$
DECLARE
  v_random_suffix VARCHAR(4);
BEGIN
  -- 生成4位随机字符(大写字母和数字)
  v_random_suffix := upper(substring(md5(random()::text) from 1 for 4));

  -- 格式:P+年月日时分秒+4位随机字符
  -- 例:P20250115142530A1B2
  NEW.patient_no := 'P' || to_char(CURRENT_TIMESTAMP, 'YYYYMMDDHH24MISS') || v_random_suffix;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_generate_patient_no
  BEFORE INSERT ON patients
  FOR EACH ROW
  WHEN (NEW.patient_no IS NULL)
  EXECUTE FUNCTION generate_patient_no();
```

---

## 7. 数据初始化

### 7.1 系统配置初始化

```sql
INSERT INTO system_configs (config_key, config_value, config_type, description) VALUES
-- 时间窗口参数
('v1_to_v2_days', '7', 'number', 'V1到V2间隔天数'),
('v1_to_v2_tolerance', '1', 'number', 'V1到V2容差天数(±1天,即6-8天)'),
('v2_to_v3_days', '21', 'number', 'V2到V3间隔天数'),
('v2_to_v3_tolerance', '2', 'number', 'V2到V3容差天数(±2天,即19-23天)'),
('v3_to_v4_days', '7', 'number', 'V3到V4间隔天数'),
('v3_to_v4_tolerance', '2', 'number', 'V3到V4容差天数(±2天,即5-9天)'),

-- 文件上传参数
('max_file_size', '10485760', 'number', '最大文件大小(10MB,单位:字节)'),
('allowed_image_types', '["jpg","jpeg","png"]', 'json', '允许的图片格式'),
('allowed_doc_types', '["pdf","doc","docx"]', 'json', '允许的文档格式'),

-- 推送消息参数
('push_enabled', 'true', 'string', '是否启用推送通知'),
('push_overdue_advance_days', '1', 'number', '超时催办提前天数');
```

### 7.2 量表配置初始化

量表配置数据需要将[量表.md](e:\于思远\工作\按公司分类\南京脑科医院\项目\睡眠小程序\sleep\量表.md)中的6个量表转换为JSON格式后插入`scale_configs`表。

**AIS量表示例**:
```sql
INSERT INTO scale_configs (scale_code, scale_name, scale_type, total_items, config_json)
VALUES (
  'AIS',
  '雅典失眠量表',
  'self',
  8,
  '{
    "description": "评估最近一周的睡眠情况",
    "items": [
      {
        "id": 1,
        "question": "入睡延迟(关灯后到入睡的时间)",
        "options": [
          {"value": 0, "label": "没有问题(小于10分钟)"},
          {"value": 1, "label": "轻微(10-30分钟)"},
          {"value": 2, "label": "明显(30-60分钟)"},
          {"value": 3, "label": "显著或基本没睡(大于1小时)"}
        ]
      },
      {
        "id": 2,
        "question": "夜间睡眠中断(每晚醒来次数)",
        "options": [
          {"value": 0, "label": "没有问题"},
          {"value": 1, "label": "轻微"},
          {"value": 2, "label": "明显"},
          {"value": 3, "label": "显著"}
        ]
      }
    ],
    "scoring": {
      "type": "sum",
      "max_score": 24,
      "description": "各题得分相加,总分0-24分"
    }
  }'::jsonb
);
```

*注: 其他5个量表(ESS、GAD7、PHQ9、HAMA、HAMD)的初始化SQL类似,详见量表.md文档*

### 7.3 默认超级管理员初始化

```sql
-- 插入超级管理员用户
INSERT INTO users (openid, unionid, role, name, gender, phone, status)
VALUES ('admin_openid_default', NULL, 'admin', '系统管理员', 'male', NULL, 'active');
```

---

## 8. ER图说明

### 8.1 核心实体关系

```
┌──────────────────────────────────────────────────────────────┐
│                        核心实体关系图                         │
└──────────────────────────────────────────────────────────────┘

[users] ───1:1──► [doctors] ───M:1──► [hospitals]
   │                   │
   │                   └─────────1:M──► [patients] ───M:1──► [hospitals]
   │                                        │
   └────────1:1────────────────────────────┘

[patients] ───1:M──► [stage_records]
                            │
                            ├─1:M──► [scale_records]
                            ├─1:M──► [medication_records]
                            ├─1:M──► [concomitant_medications]
                            ├─1:M──► [adverse_events] ───1:M──► [ae_attachments]
                            └─1:M──► [medical_files]

[stage_records] ───1:M──► [audit_logs]

[users] ───1:M──► [push_messages]

[scale_configs] (配置表,不直接关联)
[system_configs] (配置表,不直接关联)
[operation_logs] (日志表,弱关联users)
```

### 8.2 数据流转说明

1. **用户注册**: users → doctors/patients
2. **医生审核**: doctors.audit_status变更
3. **患者入组**: patients创建,绑定doctor和hospital
4. **阶段流程**: stage_records → 触发器 → patients时间窗口更新
5. **量表填写**: scale_records关联stage_records
6. **审核流程**: stage_records.audit_result → audit_logs → 触发时间窗口计算
7. **消息推送**: 各业务表 → push_messages

---

## 9. 数据库优化策略

### 9.1 查询优化

#### 9.1.1 常用查询示例

**患者列表查询**(医生端):
```sql
SELECT
  p.id,
  p.patient_no,
  p.current_stage,
  u.name,
  u.phone,
  p.enrollment_date
FROM patients p
JOIN users u ON p.user_id = u.id
WHERE p.doctor_id = ?
  AND p.current_stage IN ('V1', 'V2', 'V3', 'V4')
ORDER BY p.enrollment_date DESC
LIMIT 20 OFFSET 0;
```

**量表得分趋势查询**:
```sql
-- 创建视图简化查询
CREATE VIEW v_scale_scores AS
SELECT
  sr.patient_id,
  sr.scale_code,
  sr.stage_record_id,
  stg.stage,
  sr.total_score,
  sr.completed_at
FROM scale_records sr
JOIN stage_records stg ON sr.stage_record_id = stg.id
WHERE stg.status = 'approved';

-- 使用视图查询
SELECT * FROM v_scale_scores
WHERE patient_id = ? AND scale_code = 'AIS'
ORDER BY completed_at;
```

### 9.2 Redis缓存策略

**缓存键设计**:
- 用户信息: `user:{user_id}`
- 患者信息: `patient:{patient_id}`
- 量表配置: `scale:config:{scale_code}`
- 系统配置: `system:config:{config_key}`

**缓存过期时间**:
- 用户信息: 7天
- 患者信息: 1天
- 量表配置: 永久(更新时主动失效)
- 系统配置: 永久(更新时主动失效)

### 9.3 数据备份策略

**全量备份**:
```bash
# 每日凌晨3:00全量备份
0 3 * * * pg_dump -h localhost -U postgres -d sleep_tracking -F c -f /backup/sleep_tracking_$(date +\%Y\%m\%d).dump
```

**增量备份**(WAL归档):
```ini
# postgresql.conf
wal_level = replica
archive_mode = on
archive_command = 'test ! -f /backup/wal_archive/%f && cp %p /backup/wal_archive/%f'
```

**备份保留策略**:
- 全量备份保留30天
- WAL归档保留7天

---

## 10. 附录

### 10.1 数据库表总览

| 序号 | 表名 | 中文名 | 记录数预估 |
|------|------|--------|-----------|
| 1 | users | 用户基础表 | 10,000 |
| 2 | hospitals | 医院表 | 50 |
| 3 | doctors | 医生表 | 500 |
| 4 | patients | 患者表 | 10,000 |
| 5 | stage_records | 阶段记录表 | 40,000 |
| 6 | scale_configs | 量表配置表 | 6 |
| 7 | scale_records | 量表记录表 | 240,000 |
| 8 | medication_records | 用药记录表 | 40,000 |
| 9 | concomitant_medications | 合并用药表 | 20,000 |
| 10 | adverse_events | 不良事件表 | 5,000 |
| 11 | ae_attachments | AE附件表 | 2,000 |
| 12 | medical_files | 病例文件表 | 30,000 |
| 13 | audit_logs | 审核记录表 | 80,000 |
| 14 | push_messages | 推送消息表 | 200,000 |
| 15 | system_configs | 系统配置表 | 20 |
| 16 | operation_logs | 操作日志表 | 500,000 |

### 10.2 变更记录

| 版本 | 日期 | 变更人 | 变更内容 |
|------|------|--------|----------|
| V1.0 | 2025-01-15 | Claude | 初始版本,完成16张表设计 |

---

**文档结束**
