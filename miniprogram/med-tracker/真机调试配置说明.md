# 微信小程序真机调试配置说明

## 问题原因

真机调试时出现 `ERR_CONNECTION_REFUSED` 错误，是因为手机无法访问 `localhost:3000`。`localhost` 只能在同一台电脑上访问，手机需要通过局域网 IP 或公网域名访问后端服务。

## 解决步骤

### 第一步：获取电脑的局域网 IP 地址

#### Windows 系统
1. 打开命令提示符（Win + R，输入 `cmd`）
2. 输入命令：`ipconfig`
3. 找到 "无线局域网适配器 WLAN" 或 "以太网适配器" 下的 "IPv4 地址"
4. 例如：`192.168.1.100`

#### Mac/Linux 系统
1. 打开终端
2. 输入命令：`ifconfig` 或 `ip addr`
3. 找到 `en0` 或 `wlan0` 接口下的 inet 地址
4. 例如：`192.168.1.100`

### 第二步：修改小程序配置

打开文件 `src/config/index.ts`，将 `getBaseURL()` 函数中的返回值修改为你的局域网 IP：

```typescript
function getBaseURL(): string {
  if (process.env.NODE_ENV === 'production') {
    return 'https://your-domain.com';
  }

  // 修改这里：替换为你的电脑 IP 地址
  return 'http://192.168.1.100:3000'; // 改成你实际的 IP
}
```

### 第三步：确保后端服务监听所有网络接口

检查后端配置，确保 NestJS 监听 `0.0.0.0` 而不是 `127.0.0.1`：

**backend/src/main.ts：**
```typescript
await app.listen(3000, '0.0.0.0'); // 监听所有网络接口
```

或者在 Docker Compose 中已经配置了端口映射，应该可以正常访问。

### 第四步：配置微信开发者工具

1. 打开微信开发者工具
2. 点击右上角"详情"
3. 在"本地设置"中，勾选：
   - ✅ **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**
   - ✅ **不校验合法域名**

### 第五步：确保手机和电脑在同一局域网

- 手机和电脑需要连接到同一个 WiFi 网络
- 如果连接不同网络或使用移动数据，无法访问

### 第六步：关闭防火墙（可选）

如果仍然无法连接，可能是防火墙阻止了端口访问：

#### Windows 防火墙
1. 控制面板 → Windows Defender 防火墙 → 高级设置
2. 入站规则 → 新建规则 → 端口
3. 添加 TCP 端口 3000

#### Mac 防火墙
```bash
# 临时关闭防火墙测试
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off
```

### 第七步：重新编译小程序

```bash
npm run dev:mp-weixin
```

### 第八步：真机调试

1. 在微信开发者工具中点击"真机调试"
2. 使用手机微信扫码
3. 现在应该可以正常连接后端了

## 验证连接

### 1. 测试后端是否可访问

在手机浏览器或电脑浏览器中访问：
```
http://你的IP地址:3000/api-docs
```

如果能看到 Swagger 文档页面，说明后端可以正常访问。

### 2. 查看小程序控制台

在微信开发者工具的控制台中查看：
- 是否有请求发出
- 请求的完整 URL 是否正确
- 是否有其他错误信息

## 生产环境配置

生产环境需要：

1. **配置服务器域名**
   - 修改 `config/index.ts` 中的生产环境域名
   - 域名需要备案并配置 HTTPS

2. **在微信公众平台配置服务器域名**
   - 登录微信公众平台：https://mp.weixin.qq.com
   - 开发 → 开发管理 → 开发设置 → 服务器域名
   - 添加你的后端域名（必须是 HTTPS）

3. **关闭"不校验合法域名"选项**

## 常见问题

### 问题 1：手机扫码后立即断开
- 检查手机和电脑是否在同一 WiFi
- 检查 IP 地址是否配置正确

### 问题 2：请求超时
- 检查防火墙设置
- 确认后端服务正在运行：`docker ps` 查看容器状态
- 使用 `curl` 测试：`curl http://你的IP:3000/api`

### 问题 3：仍然显示 localhost
- 清除编译缓存，重新运行 `npm run dev:mp-weixin`
- 确认修改的是正确的配置文件

### 问题 4：Docker 容器中的后端无法访问
检查 `docker-compose.yml` 中的端口映射：
```yaml
services:
  backend:
    ports:
      - "3000:3000"  # 确保端口正确映射
```

## 推荐的开发流程

1. **开发者工具模拟器测试**：使用 `localhost`
2. **真机调试**：使用局域网 IP（如 `192.168.1.100`）
3. **体验版/正式版**：使用 HTTPS 域名
