# 睡眠小程序需求文档

**项目名称**：失眠患者用药跟踪与量表填写系统
**文档版本**：V1.0
**编写日期**：2025年
**编写人**：Claude
**适用范围**：南京脑科医院及相关研究机构

---

## 目录

1. [项目概述](#1-项目概述)
2. [系统架构](#2-系统架构)
3. [功能需求](#3-功能需求)
4. [非功能性需求](#4-非功能性需求)
5. [界面设计要求](#5-界面设计要求)
6. [风险与注意事项](#6-风险与注意事项)
7. [附录](#7-附录)

---

## 1. 项目概述

### 1.1 项目背景

失眠是一种常见的睡眠障碍,影响患者的生活质量和身心健康。为了更好地跟踪失眠患者的治疗效果、用药情况和量表评估,需要开发一套完整的数字化管理系统,帮助医生和患者进行规范化的临床研究管理。

### 1.2 项目目标

- **实现数字化管理**:将传统纸质记录转换为电子化管理,提高数据准确性和可追溯性
- **规范研究流程**:通过系统化的四阶段流程(V1-V4),确保临床研究的规范性和完整性
- **实时数据采集**:患者自主填写量表和记录用药,医生实时查看和审核
- **数据分析支持**:为科研提供完整、准确的数据支持,方便统计分析和导出
- **提升用户体验**:通过小程序和Web端,为患者和医生提供便捷的操作体验

### 1.3 适用范围

- 南京脑科医院
- 其他参与临床研究的医疗机构
- 失眠患者临床研究项目

### 1.4 系统用户角色

#### 1.4.1 超级管理员
- **主要职责**:系统全局管理
- **权限范围**:
  - 审核医生注册申请
  - 管理医院信息
  - 系统配置管理
  - 查看全局数据统计

#### 1.4.2 研究者(医生)
- **主要职责**:患者管理和数据审核
- **权限范围**:
  - 查看所管理患者的所有数据
  - 审核患者各阶段提交的资料
  - 辅助填写医生代填量表(HAMA、HAMD)
  - 查看患者AE记录
  - 导出患者数据

#### 1.4.3 受试者(患者)
- **主要职责**:自主记录和提交资料
- **权限范围**:
  - 填写自评量表
  - 上传病例文件
  - 记录用药情况
  - 记录不良事件(AE)
  - 查看审核结果和历史记录

---

## 2. 系统架构

### 2.1 技术架构

#### 2.1.1 前端技术

**微信小程序**
- 开发方式:原生微信小程序开发
- UI组件库:Vant Weapp (推荐)
- 状态管理:MobX
- 特点:
  - 良好的微信生态集成
  - 支持订阅消息推送
  - 轻量级,启动快速

**Web管理后台**
- 框架:Vue 3 + Vite
- UI组件库:Element Plus / Ant Design Vue
- 状态管理:Pinia
- 路由:Vue Router
- HTTP请求:Axios
- 数据可视化:ECharts

#### 2.1.2 后端技术

**推荐技术栈:Node.js + Nest.js**

**选型理由**:
1. **技术栈统一**:前后端使用同一语言(JavaScript/TypeScript),便于团队协作
2. **企业级框架**:Nest.js提供完整的MVC架构,代码结构清晰
3. **微信生态集成**:Node.js对微信API支持良好,便于实现登录和推送
4. **性能满足**:异步I/O特性适合处理高并发请求和消息推送场景
5. **生态丰富**:NPM包生态完善,第三方库丰富

**核心模块**:
- 用户认证与授权(Passport + JWT)
- 数据库ORM(TypeORM)
- 文件上传(Multer + OSS)
- 定时任务(node-cron)
- 日志系统(Winston)
- 接口文档(Swagger)

#### 2.1.3 数据库

**推荐:PostgreSQL 14+**

**选型理由**:
1. **数据完整性**:ACID特性强,适合医疗数据管理
2. **JSON支持**:JSONB类型适合存储量表动态配置
3. **性能优越**:支持复杂查询和全文检索
4. **开源免费**:社区活跃,无许可费用
5. **扩展性强**:支持丰富的扩展插件

**相关组件**:
- Redis:缓存、Session管理
- OSS对象存储:病例文件和附件存储(推荐阿里云OSS)

### 2.2 系统部署架构

```
                           ┌─────────────────┐
                           │   微信小程序     │
                           │  (患者端/医生端) │
                           └────────┬────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
             ┌──────▼─────┐  ┌─────▼──────┐ ┌─────▼─────┐
             │ Web管理后台 │  │ API Gateway │ │ 微信服务器 │
             │   (Vue 3)  │  │   (Nginx)   │ │           │
             └──────┬─────┘  └─────┬──────┘ └───────────┘
                    │               │
                    └───────┬───────┘
                            │
                    ┌───────▼────────┐
                    │  后端服务层     │
                    │  (Nest.js)     │
                    └───────┬────────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
     ┌──────▼──────┐ ┌─────▼──────┐ ┌─────▼──────┐
     │ PostgreSQL  │ │   Redis    │ │ 阿里云OSS  │
     │  (主数据库) │ │  (缓存)    │ │ (文件存储) │
     └─────────────┘ └────────────┘ └────────────┘
```

### 2.3 数据流转

1. **用户认证流程**:微信小程序 → 微信服务器 → 后端 → 返回JWT Token
2. **数据提交流程**:小程序/Web → API → 后端验证 → 数据库
3. **文件上传流程**:小程序/Web → 后端 → OSS → 返回URL → 保存数据库
4. **消息推送流程**:定时任务/事件触发 → 后端 → 微信服务器 → 小程序

---

## 3. 功能需求

### 3.1 用户管理模块

#### 3.1.1 医院管理

**功能描述**:系统支持多医院使用,医院数据隔离管理

**功能列表**:
- 医院信息录入(名称、地址、联系方式)
- 医院列表查询
- 医院信息编辑
- 医院状态管理(启用/禁用)

**业务规则**:
- 医院名称不可重复
- 禁用医院后,该医院下的医生无法审核新患者
- 医院数据仅超级管理员可管理

#### 3.1.2 医生注册与审核

**注册流程**:
1. 医生通过小程序提交注册申请
2. 填写基本信息:
   - 姓名
   - 工号
   - 所属医院(选择)
   - 科室
   - 职称
   - 联系方式
   - 资质证明文件上传(医师执业证书等)
3. 提交后等待超级管理员审核

**审核流程**:
1. 超级管理员在Web后台查看待审核医生列表
2. 查看医生详细信息和资质证明
3. 审核决策:
   - 通过:医生账户激活,可登录系统
   - 驳回:填写驳回原因,医生收到通知

**业务规则**:
- 医生注册后默认状态为"待审核"
- 审核通过后才可使用系统功能
- 医生信息修改需要重新审核

#### 3.1.3 患者注册与绑定

**注册流程**:
1. 患者首次使用小程序进行微信授权登录
2. 填写基本信息:
   - 姓名
   - 性别(男/女)
   - 出生日期
   - 就诊医院(下拉选择)
   - 主治医生(根据选择的医院自动筛选医生列表)
   - 手机号
3. 提交后自动绑定医生,无需医生确认

**业务规则**:
- 患者与医生自动绑定,无需审核
- 患者编号由系统自动生成(格式:P+时间戳+随机数)
- 患者绑定后默认进入V1阶段
- 患者基本信息可修改,但不影响阶段进度

### 3.2 四阶段流程管理

#### 3.2.1 时间窗口控制机制

**核心规则**:
- V1 → V2:V1审核通过后,需在第6-8天内完成V2(7天±1天)
- V2 → V3:V2审核通过后,需在第19-23天内完成V3(21天±2天)
- V3 → V4:V3审核通过后,需在第5-9天内完成V4(7天±2天)

**系统控制**:
- 时间窗口未开放前,患者无法提交该阶段资料
- 时间窗口开放时,系统推送提醒通知患者
- 超出时间窗口后,系统禁止提交,并推送超时通知

**时间窗口计算**:
- 由数据库触发器自动计算各阶段的时间窗口
- 窗口开始日期 = 上一阶段审核通过日期 + 基准天数 - 容差天数
- 窗口结束日期 = 上一阶段审核通过日期 + 基准天数 + 容差天数

#### 3.2.2 V1阶段(基线期)

**患者端操作任务**:

**1. 上传病例资料**
- 支持文件格式:jpg、jpeg、png、pdf、doc、docx
- 单文件大小限制:≤10MB
- 文件分类:检查报告、影像资料、病历记录、其他
- 支持上传多个文件
- 文件预览功能(图片直接显示,文档可下载)

**2. 填写患者自评量表**
- AIS(雅典失眠量表):8题,0-3分,总分0-24
- ESS(Epworth嗜睡量表):8题,0-3分,总分0-24
- GAD-7(广泛性焦虑量表):7题,0-3分,总分0-21
- PHQ-9(患者健康问卷抑郁量表):9题,0-3分,总分0-27

**量表填写要求**:
- 所有题目必填
- 答题进度自动保存(防止中途退出丢失)
- 提交后自动计算总分
- 支持查看历史填写记录

**3. 医生辅助填写量表**(需等待医生到场)
- HAMA(汉密尔顿焦虑量表):14题,0-4分,总分0-56
- HAMD(汉密尔顿抑郁量表24项):24题,复杂评分,医生代填

**4. 记录不良事件(AE)**
- 事件名称/描述
- 严重程度:轻度/中度/重度
- 发生日期和时间
- 持续时间
- 与研究药物的关系:无关/疑似相关/可能相关/肯定相关
- 是否需要医疗干预:是/否
- 处理措施描述
- 结局:恢复/恢复中/未恢复/后遗症/死亡
- 附件上传(可选,如检查报告)

**5. 填写用药记录**
- 药物名称:莱博雷生(固定)
- 剂量选择:5mg / 10mg
- 用药日期和时间
- 用药频率
- 备注信息

**6. 提交审核**
- 确认所有必填项已完成
- 提交后状态变更为"待审核"
- 推送通知医生审核

**医生端操作**:

**1. 辅助填写量表**
- 与患者面对面,代填HAMA和HAMD量表
- 系统自动计分

**2. 审核V1资料**
- 查看患者上传的病例文件
- 查看所有量表填写结果和得分
- 查看AE记录
- 查看用药记录

**3. 审核决策**
- **通过**:
  - 记录审核时间和审核人
  - 系统自动计算V2时间窗口
  - 推送通知患者"V1审核通过"
  - 患者进入V2阶段
- **不通过**:
  - 必填驳回原因
  - 可选填具体修改意见
  - 推送通知患者"V1审核未通过,请修改后重新提交"
  - 患者根据意见修改后重新提交

#### 3.2.3 V2阶段(治疗期-第1次随访)

**患者端操作任务**:

**1. 填写合并用药信息**
- 药品名称(输入)
- 药品分类(可选)
- 剂量
- 用药频率
- 用药原因/适应症
- 开始日期
- 结束日期(如持续中则为空)
- 支持添加多条合并用药记录

**2. 填写患者自评量表**
- 与V1相同的4个量表:AIS、ESS、GAD-7、PHQ-9

**3. 记录AE**
- 与V1相同的AE记录功能

**4. 填写用药记录**
- 莱博雷生 5mg/10mg
- 记录用药情况

**5. 提交审核**

**医生端操作**:
- 审核V2资料
- 通过/驳回决策
- 通过后系统自动计算V3时间窗口

**业务规则**:
- V2时间窗口未开放前无法提交
- 时间窗口:V1审核通过后第6-8天

#### 3.2.4 V3阶段(治疗期-第2次随访)

**患者端操作任务**:

**1. 上传病例资料**
- 与V1相同的病例上传功能

**2. 填写患者自评量表**
- AIS、ESS、GAD-7、PHQ-9

**3. 医生辅助填写量表**
- HAMA、HAMD(医生代填)

**4. 记录AE**

**5. 填写用药记录**
- 莱博雷生 5mg/10mg

**6. 提交审核**

**医生端操作**:
- 辅助填写HAMA、HAMD量表
- 审核V3资料
- 通过/驳回决策
- 通过后系统自动计算V4时间窗口

**业务规则**:
- 时间窗口:V2审核通过后第19-23天

#### 3.2.5 V4阶段(治疗期-第3次随访/结束期)

**患者端操作任务**:

**1. 填写合并用药**
- 与V2相同

**2. 填写患者自评量表**
- AIS、ESS、GAD-7、PHQ-9

**3. 记录AE**

**4. 提交审核**

**医生端操作**:
- 审核V4资料
- 通过后流程结束,患者状态变更为"已完成"

**业务规则**:
- 时间窗口:V3审核通过后第5-9天
- V4审核通过后,整个研究流程结束

### 3.3 量表管理模块

#### 3.3.1 量表配置

**配置方式**:
- 量表题目、选项、计分规则存储在数据库的JSONB字段
- 支持灵活配置不同量表的结构

**6个量表详细规格**:

**1. AIS(雅典失眠量表)** - 患者自评
- 题目数量:8题
- 评分标准:0-3分(0=没有问题,1=轻微,2=明显,3=显著或基本没睡)
- 总分范围:0-24分
- 题目内容:
  1. 入睡延迟(关灯后到入睡的时间)
  2. 夜间睡眠中断(每晚醒来次数)
  3. 早醒
  4. 睡眠时间
  5. 对总体睡眠质量评价
  6. 对白天情绪的影响
  7. 对白天功能的影响(身体与心理)
  8. 白天困意情况
- 计分方式:各题得分相加

**2. ESS(Epworth嗜睡量表)** - 患者自评
- 题目数量:8题
- 评分标准:0-3分(0=从不打瞌睡,1=轻度可能,2=中度可能,3=高度可能)
- 总分范围:0-24分
- 题目内容:
  1. 坐着阅读
  2. 看电视
  3. 在公共场所坐着不动
  4. 作为乘客在汽车中坐1小时
  5. 在环境允许的情况下躺下休息
  6. 坐下与人谈话
  7. 午餐不喝酒,餐后安静的坐着
  8. 遇堵车时停车数分钟
- 计分方式:各题得分相加

**3. GAD-7(广泛性焦虑量表)** - 患者自评
- 题目数量:7题
- 评分标准:0-3分(0=完全不会,1=好几天,2=超过一周,3=几乎每天)
- 总分范围:0-21分
- 评估时间:过去两周
- 题目内容:
  1. 感觉紧张、焦虑或急切
  2. 不能够停止或控制担忧
  3. 对各种各样的事情担忧过多
  4. 很难放松下来
  5. 由于不安而无法静坐
  6. 变得容易烦恼或急躁
  7. 感到似乎将有可怕的事情发生而害怕
- 计分方式:各题得分相加

**4. PHQ-9(患者健康问卷抑郁量表)** - 患者自评
- 题目数量:9题
- 评分标准:0-3分(0=没有,1=有几天,2=一半以上时间,3=几乎每天)
- 总分范围:0-27分
- 评估时间:过去两周
- 题目内容:
  1. 做事时提不起劲或没有兴趣
  2. 感到心情低落、沮丧或绝望
  3. 入睡困难、睡不安或睡得过多
  4. 感觉疲倦或没有活力
  5. 食欲不振或吃太多
  6. 觉得自己很糟或觉得自己很失败
  7. 对事物专注有困难
  8. 行动或说话速度缓慢或过于烦躁
  9. 有不如死掉或用某种方式伤害自己的念头
- 计分方式:各题得分相加

**5. HAMA(汉密尔顿焦虑量表)** - 医生代填
- 题目数量:14题
- 评分标准:0-4分(0=无,1=轻,2=中,3=重,4=极重)
- 总分范围:0-56分
- 题目内容:
  1. 焦虑心境
  2. 紧张
  3. 害怕
  4. 失眠
  5. 认知功能
  6. 抑郁心境
  7. 躯体性焦虑(肌肉系统)
  8. 躯体性焦虑(感觉系统)
  9. 心血管系统症状
  10. 呼吸系统症状
  11. 胃肠道症状
  12. 生殖泌尿系统症状
  13. 植物神经系统症状
  14. 会谈时行为表现
- 计分方式:各题得分相加

**6. HAMD(汉密尔顿抑郁量表-24项版本)** - 医生代填
- 题目数量:24题
- 评分标准:不同条目有不同评分标准(0-2分或0-4分)
- 题目内容:
  1. 抑郁情绪
  2. 有罪感
  3. 自杀
  4. 入睡困难
  5. 睡眠不深
  6. 早醒
  7. 工作和兴趣
  8. 迟缓
  9. 激越
  10. 精神焦虑
  11. 躯体性焦虑
  12. 胃肠道症状
  13. 全身症状
  14. 性症状
  15. 疑病
  16. 体重减轻
  17. 自知力
  18. 日夜变化
  19. 人格解体或现实解体
  20. 偏执症状
  21. 强迫症状
  22. 能力减退感
  23. 绝望感
  24. 自卑感
- 计分方式:根据量表规则计算总分

#### 3.3.2 量表填写功能

**通用功能**:
- 题目逐题显示或分页显示
- 答题进度保存(本地缓存)
- 进度条展示(已完成X/总共Y题)
- 必填项校验
- 提交前确认

**自动计分**:
- 提交后系统根据配置规则自动计算总分
- 实时显示得分结果

**历史记录**:
- 查看历史量表填写记录
- 按阶段筛选
- 查看得分趋势图表

**结果对比**:
- 同一量表不同阶段的得分对比
- 折线图展示趋势
- 支持导出对比报告

### 3.4 不良事件(AE)管理

#### 3.4.1 AE记录

**记录字段**:
- 事件名称(简短描述,必填)
- 事件详细描述(必填)
- 严重程度(必填):
  - 轻度(mild):不影响日常活动
  - 中度(moderate):轻度影响日常活动
  - 重度(severe):显著影响日常活动或危及生命
- 发生日期(必填)
- 发生时间(可选)
- 持续时间(如"3小时"、"2天")
- 与研究药物的关系(必填):
  - 无关(unrelated)
  - 不太可能(unlikely)
  - 可能(possible)
  - 很可能(probable)
  - 肯定(definite)
- 是否需要医疗干预:是/否
- 处理措施描述(如需要干预则必填)
- 结局(必填):
  - 已恢复(recovered)
  - 恢复中(recovering)
  - 未恢复(not_recovered)
  - 有后遗症(sequelae)
  - 死亡(death)
- 是否严重AE(系统判断:选择"重度"或"结局为死亡"时自动标记)

**附件上传**:
- 支持上传相关检查报告、影像资料
- 文件格式:图片、PDF
- 单文件大小:≤10MB

#### 3.4.2 AE查看与管理

**患者端**:
- 查看自己的AE记录列表
- 查看AE详情
- 编辑未提交的AE记录

**医生端**:
- 查看所管理患者的所有AE记录
- 按严重程度筛选
- 按时间筛选
- 导出AE报表

#### 3.4.3 严重AE预警

**预警规则**:
- 患者记录严重AE(重度或死亡)时
- 系统自动标记为严重AE
- 立即推送通知给患者的主治医生

**推送内容**:
- 患者姓名
- AE事件名称
- 严重程度
- 发生时间
- 快速查看链接

### 3.5 用药记录管理

#### 3.5.1 主要用药记录(莱博雷生)

**记录内容**:
- 药物名称:莱博雷生(系统固定,不可修改)
- 剂量选择:5mg / 10mg(单选)
- 剂型(可选):片剂
- 给药途径(可选):口服
- 用药频率(必填):
  - 每日一次
  - 每日两次
  - 按需使用
  - 其他(需填写说明)
- 开始日期(必填)
- 结束日期(可选,如持续用药则为空)
- 用药天数(自动计算)
- 依从性评估(可选):
  - 良好(good):按医嘱规律服药
  - 一般(fair):偶尔漏服
  - 差(poor):经常漏服或未按医嘱服药
- 备注(可选)

#### 3.5.2 合并用药记录

**记录内容**:
- 药品名称(必填,输入框)
- 药品分类(可选):
  - 降压药
  - 降糖药
  - 抗抑郁药
  - 抗焦虑药
  - 其他
- 剂量(必填,如"50mg"、"10ml")
- 用药频率(可选)
- 用药原因/适应症(必填)
- 开始日期(必填)
- 结束日期(可选)
- 是否持续中(勾选框)

**功能特性**:
- 支持添加多条合并用药记录
- 支持编辑和删除
- 按时间排序显示
- 区分"持续用药"和"已停药"

#### 3.5.3 用药记录查看

**患者端**:
- 查看自己的用药历史
- 按阶段筛选
- 时间轴展示

**医生端**:
- 查看患者完整用药记录
- 分析用药依从性
- 导出用药记录

### 3.6 病例文件管理

#### 3.6.1 文件上传

**支持的文件类型**:
- 图片:jpg、jpeg、png
- 文档:pdf、doc、docx

**上传限制**:
- 单文件大小:≤10MB
- 单次上传数量:≤5个文件
- 总存储空间:按患者计算,每位患者≤100MB

**文件分类**:
- 检查报告
- 影像资料
- 病历记录
- 其他

**上传流程**:
1. 患者选择文件类型
2. 选择文件分类
3. 选择文件上传
4. 系统校验文件格式和大小
5. 上传到OSS对象存储
6. 返回文件URL保存到数据库

#### 3.6.2 文件管理

**文件预览**:
- 图片:直接在小程序中显示
- PDF:在线预览或下载后查看
- Word文档:提示下载后查看

**文件操作**:
- 下载
- 删除(仅限患者本人,且未提交审核前)
- 重命名(可选)

**文件归档**:
- 按阶段归档
- 按文件分类筛选
- 按上传时间排序

#### 3.6.3 医生查看

**查看权限**:
- 医生可查看所管理患者的所有病例文件
- 支持在线预览和下载
- 可添加查看批注(可选功能)

### 3.7 审核管理模块

#### 3.7.1 审核流程

**提交审核**:
1. 患者完成阶段所有必填项
2. 点击"提交审核"按钮
3. 系统校验必填项完整性
4. 提交成功后状态变更为"待审核"
5. 推送通知医生

**医生审核**:
1. 医生登录小程序或Web后台
2. 查看"待审核列表"
3. 点击某位患者进入详情页
4. 查看患者提交的所有资料:
   - 病例文件
   - 量表填写结果和得分
   - AE记录
   - 用药记录
   - 合并用药记录
5. 做出审核决策

**审核决策**:

**通过**:
- 点击"审核通过"按钮
- 系统记录审核时间和审核人
- 触发数据库触发器:
  - 计算下一阶段时间窗口
  - 更新患者当前阶段
- 推送通知患者:"您的[V1/V2/V3/V4]阶段已审核通过"
- 如果是V4阶段通过,流程结束,患者状态变更为"已完成"

**不通过**:
- 点击"审核不通过"按钮
- 必填:驳回原因(选择或输入)
  - 病例资料不完整
  - 量表填写有误
  - 用药记录不清楚
  - 其他(需填写具体原因)
- 可选:具体修改意见(文本框)
- 系统记录审核时间、审核人、驳回原因
- 推送通知患者:"您的[V1/V2/V3/V4]阶段审核未通过,请根据医生意见修改后重新提交"
- 患者状态保持在当前阶段
- 患者根据意见修改后可重新提交

#### 3.7.2 审核记录

**记录内容**:
- 审核阶段(V1/V2/V3/V4)
- 患者信息
- 审核人(医生)
- 审核时间
- 审核结果(通过/不通过)
- 审核意见/驳回原因

**查看方式**:
- 患者端:查看自己的审核历史
- 医生端:查看患者的审核历史
- 管理员:查看所有审核记录

**统计功能**:
- 医生审核工作量统计
- 各阶段通过率统计
- 驳回原因分析

### 3.8 消息推送模块

#### 3.8.1 推送场景

**患者端接收推送**:

1. **审核通过通知**
   - 标题:"[V1/V2/V3/V4]阶段审核通过"
   - 内容:"您的[V1/V2/V3/V4]阶段已通过[医生姓名]医生审核"
   - 跳转:点击跳转到下一阶段页面(如V4通过则跳转到完成页面)

2. **审核驳回通知**
   - 标题:"[V1/V2/V3/V4]阶段审核未通过"
   - 内容:"驳回原因:[医生填写的驳回原因]"
   - 跳转:点击跳转到修改页面

3. **阶段开放提醒**
   - 标题:"[V2/V3/V4]阶段已开放"
   - 内容:"您的[V2/V3/V4]阶段已开放,可填写时间:[开始日期]至[结束日期],请尽快完成"
   - 跳转:点击跳转到对应阶段页面

4. **阶段超时催办**
   - 标题:"[V2/V3/V4]阶段即将超时"
   - 内容:"您的[V2/V3/V4]阶段将于[结束日期]截止,请尽快完成提交"
   - 跳转:点击跳转到对应阶段页面
   - 触发时机:距离截止日期还有1天时推送

**医生端接收推送**:

1. **新患者绑定通知**
   - 标题:"新患者绑定"
   - 内容:"患者[姓名]已选择您为主治医生"
   - 跳转:点击跳转到患者详情页

2. **患者提交审核通知**
   - 标题:"待审核提醒"
   - 内容:"患者[姓名]已提交[V1/V2/V3/V4]阶段资料,请审核"
   - 跳转:点击跳转到审核页面

3. **严重AE提醒**
   - 标题:"严重不良事件提醒"
   - 内容:"患者[姓名]记录了严重不良事件,请及时查看"
   - 跳转:点击跳转到AE详情页
   - 优先级:高,立即推送

4. **患者超时未完成提醒**
   - 标题:"患者超时提醒"
   - 内容:"患者[姓名]的[V2/V3/V4]阶段已超时未提交"
   - 跳转:点击跳转到患者详情页

#### 3.8.2 推送方式

**微信小程序订阅消息**:
- 使用微信官方订阅消息API
- 需要用户授权订阅
- 支持模板消息配置
- 推送成功率高

**站内消息**:
- 消息中心列表展示
- 未读消息红点提示
- 消息分类(系统通知、审核通知、提醒通知)
- 支持标记已读/未读
- 支持删除

#### 3.8.3 推送时机

**实时推送**:
- 审核通过/驳回
- 严重AE提醒
- 新患者绑定

**定时推送**:
- 阶段开放提醒:每天早上9:00检查,当天进入时间窗口的推送提醒
- 超时催办:每天早上9:00检查,距离截止还有1天的推送催办
- 患者超时未完成:每天晚上21:00检查,已超时的推送医生

### 3.9 数据统计与导出

#### 3.9.1 数据统计

**统计维度**:

**1. 患者统计**
- 患者总数
- 各医院患者分布
- 各医生管理患者数
- 患者性别分布
- 患者年龄分布

**2. 阶段统计**
- 各阶段患者数量(V1/V2/V3/V4/已完成)
- 各阶段通过率
- 各阶段平均完成时间
- 超时率统计

**3. 量表得分统计**
- 各量表平均分
- 各量表得分分布(0-5分、6-10分等)
- 各阶段得分对比
- 得分趋势分析(折线图)

**4. AE统计**
- AE总数
- AE严重程度分布(轻度/中度/重度)
- 严重AE数量和占比
- AE与药物关系分析
- AE发生率

**5. 用药统计**
- 各剂量(5mg/10mg)使用人数
- 平均用药天数
- 用药依从性统计
- 合并用药种类统计

**6. 医生工作量统计**
- 各医生管理患者数
- 各医生审核数量
- 各医生审核通过率
- 各医生平均审核时间

**数据可视化**:
- 仪表盘总览(卡片形式显示关键指标)
- 饼图(患者分布、阶段分布等)
- 柱状图(各医院对比、AE分布等)
- 折线图(量表得分趋势、时间趋势等)
- 表格(详细数据列表)

#### 3.9.2 数据导出

**导出功能**:

**1. 患者基本信息导出**
- 导出字段:患者编号、姓名、性别、年龄、医院、医生、入组日期、当前阶段
- 导出格式:Excel、PDF
- 筛选条件:医院、医生、阶段、时间范围

**2. 量表数据导出**
- 导出字段:患者信息、量表名称、阶段、填写时间、各题得分、总分
- 导出格式:Excel、PDF
- Excel格式:多个sheet,每个量表一个sheet
- PDF格式:生成标准化报告,包含图表
- 筛选条件:量表类型、阶段、时间范围、医院、医生

**3. AE数据导出**
- 导出字段:患者信息、事件名称、严重程度、发生时间、处理措施、结局等
- 导出格式:Excel、PDF
- 筛选条件:严重程度、时间范围、医院、医生

**4. 用药记录导出**
- 导出字段:患者信息、药物名称、剂量、用药时间、依从性等
- 导出格式:Excel、PDF
- 筛选条件:剂量、阶段、时间范围

**5. 综合报告导出**
- 包含:患者基本信息、所有量表得分、AE记录、用药记录
- 格式:PDF
- 样式:标准化临床研究报告格式

**导出流程**:
1. 选择导出类型
2. 设置筛选条件
3. 选择导出格式(Excel/PDF)
4. 点击"导出"按钮
5. 后端生成文件
6. 前端下载文件

**性能优化**:
- 大数据量导出使用异步任务队列
- 生成进度提示
- 导出文件临时存储,设置过期时间(24小时)

---

## 4. 非功能性需求

### 4.1 安全性需求

#### 4.1.1 身份认证
- **微信小程序**:使用微信授权登录,获取用户OpenID
- **Web后台**:账号密码登录,支持验证码
- **Token机制**:JWT Token,有效期7天,自动刷新
- **权限控制**:基于角色的访问控制(RBAC)

#### 4.1.2 数据安全
- **传输加密**:全站HTTPS,SSL/TLS 1.2+
- **敏感数据加密**:
  - 手机号:AES加密存储
  - 身份证号(如有):AES加密存储
- **密码安全**:bcrypt加盐哈希(如有密码登录)
- **SQL注入防护**:使用ORM参数化查询
- **XSS防护**:前端输入过滤,后端输出转义
- **CSRF防护**:Token验证

#### 4.1.3 操作审计
- **操作日志**:记录所有敏感操作(登录、审核、导出等)
- **日志内容**:用户、操作类型、操作时间、IP地址、操作结果
- **日志保存**:至少保留6个月
- **日志查询**:支持按用户、时间、操作类型查询

### 4.2 隐私保护

#### 4.2.1 数据隐私
- **最小化原则**:只收集必要的数据
- **数据脱敏**:导出数据时可选择脱敏(隐藏姓名、手机号等)
- **访问控制**:
  - 患者只能查看自己的数据
  - 医生只能查看所管理患者的数据
  - 超级管理员可查看全局统计,但不涉及患者隐私细节

#### 4.2.2 合规性
- 符合《个人信息保护法》
- 符合《数据安全法》
- 符合医疗数据管理相关规范
- 用户协议和隐私政策明确告知

### 4.3 性能需求

#### 4.3.1 响应时间
- 页面加载时间:< 2秒
- API接口响应时间:
  - 查询接口:< 500ms
  - 提交接口:< 1秒
  - 文件上传:根据文件大小,≤10MB的文件< 5秒
  - 数据导出:
    - 小数据量(< 1000条):< 5秒
    - 大数据量(>= 1000条):使用异步任务,生成后通知下载

#### 4.3.2 并发能力
- 支持并发用户数:500+
- 支持同时在线用户数:200+
- 数据库连接池:最大连接数100

#### 4.3.3 文件处理
- 文件上传:
  - 使用OSS直传,减轻服务器压力
  - 大文件分片上传(> 5MB)
  - 上传进度显示
- 文件下载:
  - OSS URL直接下载
  - 设置URL有效期(1小时)

### 4.4 可用性需求

#### 4.4.1 系统可用性
- 目标可用性:≥99%
- 服务器宕机恢复时间:< 1小时
- 支持灰度发布,减少发布风险

#### 4.4.2 数据备份
- **数据库备份**:
  - 全量备份:每日凌晨3:00
  - 增量备份:每6小时一次
  - 备份保留期:30天
- **文件备份**:
  - OSS自动备份
  - 冗余存储
- **备份恢复**:
  - 定期演练备份恢复流程
  - RTO(恢复时间目标):< 4小时
  - RPO(恢复点目标):< 6小时

#### 4.4.3 容错处理
- **网络异常**:自动重试机制(最多3次)
- **服务异常**:友好的错误提示,不暴露技术细节
- **数据异常**:数据校验,防止脏数据入库

### 4.5 兼容性需求

#### 4.5.1 微信小程序
- 支持微信版本:最新版本及前2个稳定版本
- 支持操作系统:
  - iOS 12+
  - Android 8+
- 适配机型:主流手机,分辨率375×667 ~ 414×896

#### 4.5.2 Web后台
- 支持浏览器:
  - Chrome 90+
  - Edge 90+
  - Firefox 88+
  - Safari 14+
- 屏幕分辨率:≥1366×768
- 响应式设计:支持不同屏幕尺寸

### 4.6 可维护性需求

#### 4.6.1 代码规范
- 遵循ESLint规范
- 代码注释覆盖率:核心模块≥30%
- 函数命名清晰,见名知义

#### 4.6.2 文档要求
- 接口文档:使用Swagger自动生成
- 数据库文档:ER图和数据字典
- 部署文档:详细的部署步骤
- 用户手册:患者端和医生端操作手册

#### 4.6.3 测试要求
- 单元测试:核心业务逻辑覆盖率≥70%
- 接口测试:所有API接口测试覆盖
- 端到端测试:关键业务流程测试

---

## 5. 界面设计要求

### 5.1 设计原则

#### 5.1.1 简洁清晰
- 界面布局简洁,信息层级清晰
- 重要信息突出显示
- 减少不必要的装饰元素

#### 5.1.2 一致性
- 色彩使用一致
- 组件样式一致
- 交互方式一致
- 文案风格一致

#### 5.1.3 易用性
- 操作流程简单,步骤少
- 提供明确的操作引导
- 错误提示友好,提供解决方案
- 支持撤销和返回

### 5.2 小程序端(患者)

#### 5.2.1 首页
- 显示当前阶段状态(V1/V2/V3/V4/已完成)
- 任务清单卡片:
  - 未完成任务:红色角标提示
  - 已完成任务:绿色对勾
- 快捷入口:
  - 填写量表
  - 上传病例
  - 记录AE
  - 记录用药
- 消息通知入口(红点提示未读数)

#### 5.2.2 量表填写页面
- 顶部:进度条(已完成X/总共Y题)
- 中部:题目和选项
  - 题目文字清晰,字号适中
  - 选项排列整齐,易于点击
  - 当前选中项高亮显示
- 底部:
  - "上一题"按钮(第一题时禁用)
  - "下一题"/"提交"按钮
- 答题进度自动保存提示

#### 5.2.3 文件上传页面
- 文件选择按钮(支持相册和拍照)
- 已选文件预览(缩略图)
- 文件信息:文件名、大小、类型
- 删除按钮
- 上传进度条

#### 5.2.4 审核状态页面
- 状态图标(待审核/审核通过/审核未通过)
- 状态说明文字
- 如果是未通过:显示驳回原因
- 操作按钮:
  - 待审核:等待提示
  - 审核通过:进入下一阶段按钮
  - 审核未通过:修改后重新提交按钮

### 5.3 小程序端(医生)

#### 5.3.1 首页
- 待审核列表(突出显示,红色角标)
- 患者管理列表:
  - 患者姓名、编号
  - 当前阶段
  - 最近更新时间
- 搜索框:支持按姓名、编号搜索
- 筛选条件:按阶段筛选

#### 5.3.2 患者详情页
- 顶部:患者基本信息(姓名、性别、年龄、编号)
- 标签页切换:
  - 基本信息
  - 量表记录
  - AE记录
  - 用药记录
  - 病例文件
  - 审核历史
- 快捷操作:
  - 辅助填写量表(HAMA、HAMD)
  - 审核资料

#### 5.3.3 审核页面
- 顶部:患者信息
- 审核内容区域:
  - 病例文件列表(可预览)
  - 量表得分列表(可展开查看详情)
  - AE记录列表(可展开查看详情)
  - 用药记录列表
- 底部操作区:
  - "审核通过"按钮(绿色)
  - "审核不通过"按钮(红色)
- 驳回原因弹窗:
  - 常用原因选择(单选)
  - 具体意见输入框(可选)
  - "确认驳回"按钮

### 5.4 Web管理后台

#### 5.4.1 布局结构
- 左侧:导航菜单(可折叠)
  - 仪表盘
  - 患者管理
  - 医生管理
  - 医院管理
  - 数据统计
  - 数据导出
  - 系统配置
- 顶部:
  - Logo
  - 用户信息下拉菜单(退出登录)
  - 消息通知图标
- 中间:主内容区

#### 5.4.2 仪表盘
- 关键指标卡片:
  - 患者总数
  - 各阶段患者数
  - 待审核数量
  - 严重AE数量
- 数据可视化图表:
  - 患者阶段分布饼图
  - 量表得分趋势折线图
  - AE统计柱状图
- 最近动态列表

#### 5.4.3 数据表格
- 表头固定,内容滚动
- 支持排序(点击表头)
- 支持筛选(下拉框或输入框)
- 支持分页(每页10/20/50条可选)
- 操作列:查看、编辑、删除等按钮

#### 5.4.4 表单页面
- 表单项对齐整齐
- 必填项标红星提示
- 实时校验,错误提示清晰
- 提交按钮和取消按钮区分明显

### 5.5 色彩规范

**主色调**:
- 主色:#409EFF (蓝色,代表科技、信任)
- 辅助色:#67C23A (绿色,代表成功、健康)
- 警告色:#E6A23C (橙色,代表警告)
- 危险色:#F56C6C (红色,代表错误、危险)

**文字色**:
- 主文字:#303133
- 次要文字:#606266
- 占位符:#C0C4CC

**背景色**:
- 页面背景:#F5F7FA
- 卡片背景:#FFFFFF
- 分割线:#DCDFE6

---

## 6. 风险与注意事项

### 6.1 医疗数据安全
- **风险**:医疗数据泄露,造成患者隐私侵犯
- **应对**:
  - 严格执行数据加密和访问控制
  - 定期进行安全审计
  - 符合医疗数据管理相关法规

### 6.2 微信小程序审核
- **风险**:小程序涉及医疗类目,审核严格,可能延期上线
- **应对**:
  - 准备相关医疗资质证明
  - 提前2周提交审核,预留调整时间
  - 准备备选方案(如H5页面)

### 6.3 量表版权
- **风险**:使用量表可能涉及版权问题
- **应对**:
  - 确认量表使用是否需要授权
  - 必要时联系量表版权方获取授权

### 6.4 数据备份
- **风险**:数据丢失,无法恢复
- **应对**:
  - 建立完善的数据备份机制
  - 定期测试备份恢复流程
  - 多地冗余存储

### 6.5 用户培训
- **风险**:用户不熟悉系统操作,导致使用困难
- **应对**:
  - 编写详细的用户操作手册
  - 录制操作视频教程
  - 提供在线客服支持

### 6.6 应急预案
- **风险**:系统故障,影响正常使用
- **应对**:
  - 制定系统故障应急处理方案
  - 建立故障通知机制
  - 准备降级方案(如临时使用纸质记录)

---

## 7. 附录

### 7.1 量表详细内容

所有量表的详细题目、选项和评分标准已记录在项目文件 `量表.md` 中,包含:
- AIS(雅典失眠量表)
- ESS(Epworth嗜睡量表)
- GAD-7(广泛性焦虑量表)
- PHQ-9(患者健康问卷抑郁量表)
- HAMA(汉密尔顿焦虑量表)
- HAMD(汉密尔顿抑郁量表-24项版本)

开发时需要将量表数据结构化录入系统数据库。

### 7.2 术语表

| 术语 | 全称 | 说明 |
|------|------|------|
| AIS | Athens Insomnia Scale | 雅典失眠量表 |
| ESS | Epworth Sleepiness Scale | Epworth嗜睡量表 |
| GAD-7 | Generalized Anxiety Disorder 7-item | 广泛性焦虑量表 |
| PHQ-9 | Patient Health Questionnaire-9 | 患者健康问卷抑郁量表 |
| HAMA | Hamilton Anxiety Scale | 汉密尔顿焦虑量表 |
| HAMD | Hamilton Depression Scale | 汉密尔顿抑郁量表 |
| AE | Adverse Event | 不良事件 |
| OSS | Object Storage Service | 对象存储服务 |
| JWT | JSON Web Token | 身份认证令牌 |
| RBAC | Role-Based Access Control | 基于角色的访问控制 |

### 7.3 参考文档

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [Vue.js官方文档](https://vuejs.org/)
- [Nest.js官方文档](https://nestjs.com/)
- [PostgreSQL官方文档](https://www.postgresql.org/docs/)

---

**文档结束**
